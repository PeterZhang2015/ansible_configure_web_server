---
- name: Verify
  hosts: all
  become: true
  tasks:
    - name: Check if nginx is installed
      ansible.builtin.package:
        name: nginx
        state: present
      check_mode: true
      register: nginx_installed
      failed_when: nginx_installed.changed

    - name: Check if nginx service is running
      ansible.builtin.systemd:
        name: nginx
      register: nginx_service
      failed_when: nginx_service.status.ActiveState != "active"

    - name: Check if nginx is enabled
      ansible.builtin.systemd:
        name: nginx
      register: nginx_enabled
      failed_when: nginx_enabled.status.UnitFileState != "enabled"

    - name: Check if nginx config exists (Debian)
      ansible.builtin.stat:
        path: /etc/nginx/sites-available/default
      register: nginx_config_debian
      when: ansible_os_family == "Debian"

    - name: Verify nginx config exists (Debian)
      ansible.builtin.assert:
        that:
          - nginx_config_debian.stat.exists
        fail_msg: "Nginx config file not found"
      when: ansible_os_family == "Debian"

    - name: Check if nginx config exists (RedHat)
      ansible.builtin.stat:
        path: /etc/nginx/conf.d/default.conf
      register: nginx_config_redhat
      when: ansible_os_family == "RedHat"

    - name: Verify nginx config exists (RedHat)
      ansible.builtin.assert:
        that:
          - nginx_config_redhat.stat.exists
        fail_msg: "Nginx config file not found"
      when: ansible_os_family == "RedHat"

    - name: Test nginx is listening on port 80
      ansible.builtin.wait_for:
        port: 80
        timeout: 5
        state: started

    - name: Test nginx responds (any status is OK, just needs to respond)
      ansible.builtin.uri:
        url: http://localhost:80
        status_code: [200, 403, 404]
      register: nginx_response
      retries: 3
      delay: 2

    - name: Verify nginx is responding
      ansible.builtin.assert:
        that:
          - nginx_response.status in [200, 403, 404]
        fail_msg: "Nginx is not responding on port 80"
